#!/system/bin/sh
#
# Copyright - Ícaro Hoff <icarohoff@gmail.com>
#
#              \
#              /\
#             /  \
#            /    \
#
# Lambda Kernel Tuning - "lkt"
#

# The ultimate "Lambda" character.
char=λ

# "Current" and "default" profiles.
current=/data/lambda/lambda.profile
default=/data/lambda/balance.profile

# Import the "global tunables" for our Kernel modification API...
if [ -L $current ]; then
	# ...from "current" profile after first "lkt profile" usage.
	source $current
else
	# ...from "balance" profile if "lkt profile" was never used.
	source $default
fi

# Message the kmsg device to indicate this script is running.
echo "[$char] Entering <$1> dimension..." | tee /dev/kmsg

# Lambda profiles to be loaded from "lkt" or "spectrum".
profiler() {
	profile=$1
	if [ -f /data/lambda/${profile}.profile ]; then
		echo "[$char] Switching to <$profile> profile..." | tee /dev/kmsg
		source /data/lambda/${profile}.profile
		ln -s -f /data/lambda/${profile}.profile $current
	else
		echo "[$char] This profile is not available!" | tee /dev/kmsg
	fi
}

# The function responsible for tuning based on the exposed profile.
tuning() {
	# Switch the I/O scheduler for all MMC blocks.
	echo "$iosched" > /sys/block/sda/queue/scheduler
	echo "$iosched" > /sys/block/sde/queue/scheduler

	# If encrypted, switch the DM blocks' I/O scheduler as well.
	if [ "$(getprop ro.crypto.state)" = "encrypted" ]; then
		echo "$iosched" > /sys/block/dm-0/queue/scheduler
		echo "$iosched" > /sys/block/dm-1/queue/scheduler
	fi

	# Notify the system property that we changed the I/O scheduler.
	setprop sys.io.scheduler $iosched

	# Set the read-ahead value for all MMC blocks.
	for block_device in /sys/block/*
	do
		echo "$readahead" > $block_device/queue/read_ahead_kb
	done

	# Switch on/off filesystem sync unconditionally.
	echo "$fsync" > /sys/module/sync/parameters/fsync_enabled

	# Set the proper idle GPU frequency.
	echo "$gpupwrlvl" > /sys/class/kgsl/kgsl-3d0/default_pwrlevel
}

spectrum() {
	echo "[$char] Setting up spectrum support..." | tee /dev/kmsg
	setprop spectrum.support 1
	setprop persist.spectrum.kernel "Lambda"
	# Set the spectrum profile if not already set.
	if [ ! -f /data/property/persist.spectrum.profile ]; then
		echo "[$char] Setting spectrum profile to <$spec>..." | tee /dev/kmsg
		setprop persist.spectrum.profile "$spec"
	fi
}

# Query for the input profile passed to this script.
case $1 in
	balance)
		profiler balance
		tuning
		;;
	performance)
		profiler performance
		tuning
		;;
	battery)
		profiler battery
		tuning
		;;
	gaming)
		profiler gaming
		tuning
		;;
	spectrum)
		spectrum
		;;
esac
